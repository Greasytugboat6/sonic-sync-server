<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>SonicSync</title>
    <style>
        .active-user {
            border: 1px solid #ccc;
            padding: 10px;
            margin: 10px 0;
            display: flex;
            align-items: center;
        }
        .active-user img {
            border-radius: 50%;
            margin-right: 10px;
        }
        .track-info {
            margin-top: 10px;
        }
        .track-info img {
            border-radius: 5px;
        }
    </style>
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
</head>
<body>
    {% if session %}
        <h1>Welcome {{ session.userinfo.name }}!</h1>
        <p><a href="{{ url_for('logout') }}" id="qsLogoutBtn">Logout</a></p>
        <div><pre>{{ pretty }}</pre></div>

        {% if not spotify_token %}
            <p><a href="{{ url_for('spotify_login') }}">Connect with Spotify</a></p>
        {% else %}
            <p>Spotify is connected.</p>

            {% if spotify_profile %}
                <h2>Spotify Profile</h2>
                <p>Display Name: {{ spotify_profile.display_name }}</p>
                <p>Email: {{ spotify_profile.email }}</p>
                
                {% if spotify_profile.images and spotify_profile.images[0] %}
                    <img src="{{ spotify_profile.images[0].url }}" alt="Spotify Profile Picture" width="100" height="100">
                {% endif %}
            {% endif %}

            <!-- Active Spotify Users Section -->
            <h2>Active Spotify Users</h2>
            {% if active_profiles %}
                <div id="active-users">
                    {% for profile in active_profiles %}
                        <div class="active-user" data-user-id="{{ profile.user_id }}">
                            {% if profile.image_url %}
                                <img src="{{ profile.image_url }}" alt="{{ profile.display_name }}" width="50" height="50">
                            {% else %}
                                <img src="default_profile.png" alt="Default Profile" width="50" height="50">
                            {% endif %}
                            <div>
                                <p><strong>{{ profile.display_name }}</strong></p>
                                <p>{{ profile.email }}</p>
                                <!-- Track Info Placeholder -->
                                <div class="track-info" id="track-info-{{ profile.user_id }}">
                                    <p><em>Loading current track...</em></p>  <!-- Updated loading indicator -->
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <p>No active Spotify users at the moment.</p>
            {% endif %}
        {% endif %}
    {% else %}
        <h1 id="profileDropDown">Welcome Guest</h1>
        <p><a href="{{ url_for('login') }}" id="qsLoginBtn">Login</a></p>
    {% endif %}

    <script>
        // Connect to Socket.IO with explicit server URL
        const socket = io("https://sonic-sync-78daad0a1d18.herokuapp.com");

        // Function to fetch and display track info for each active user
        function fetchTrackInfo(userId) {
            socket.emit('find_tracks', { user_id: userId });
        }

        // Listen for the 'track_info' event and update UI for the specific user
        socket.on('track_info', (data) => {
            const userId = data.user_id;
            const trackInfoDiv = document.getElementById(`track-info-${userId}`);

            if (data.error) {
                trackInfoDiv.innerHTML = `<p>${data.error}</p>`;
                console.error("Track info error:", data.error);  // Log error details
            } else {
                const trackHtml = `
                    <p><strong>Currently Playing:</strong></p>
                    <p>${data.song_name} - ${data.artist_name}</p>
                    <img src="${data.album_image}" alt="${data.song_name}" width="100" height="100">
                `;
                trackInfoDiv.innerHTML = trackHtml;
            }
        });

        // Fetch track info for each active user every second
        document.addEventListener("DOMContentLoaded", () => {
            const activeUsers = document.querySelectorAll(".active-user");

            activeUsers.forEach(userElement => {
                const userId = userElement.getAttribute("data-user-id");

                // Set interval to fetch track info every second for each user
                setInterval(() => {
                    fetchTrackInfo(userId);
                }, 1000);
            });
        });
    </script>
</body>
</html>
