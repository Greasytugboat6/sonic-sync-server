<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>SonicSync</title>
    <style>
        .active-user {
            border: 1px solid #ccc;
            padding: 10px;
            margin: 10px 0;
            display: flex;
            align-items: center;
        }
        .active-user img {
            border-radius: 50%;
            margin-right: 10px;
        }
        .track-info {
            margin-top: 10px;
        }
        .track-info img {
            border-radius: 5px;
        }
    </style>
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
</head>
<body>
    <h1>Welcome to SonicSync!</h1>
    <p><a href="{{ url_for('logout') }}" id="qsLogoutBtn">Logout</a></p>
    <p id="connectSpotify"><a href="{{ url_for('spotify_login') }}">Connect with Spotify</a></p>

    <h2>Active Spotify Users</h2>
    <div id="active-users"></div>

    <script>
        const socket = io("https://sonic-sync-78daad0a1d18.herokuapp.com", { transports: ["websocket"] });

        // Add user to the list
        socket.on("add_user", (user) => {
            const userDiv = document.createElement("div");
            userDiv.className = "active-user";
            userDiv.id = `user-${user.user_id}`;
            userDiv.setAttribute("data-user-id", user.user_id);

            const img = document.createElement("img");
            img.src = user.image_url || "default_profile.png";
            img.alt = user.display_name;
            img.width = 50;
            img.height = 50;

            const infoDiv = document.createElement("div");
            infoDiv.innerHTML = `<p><strong>${user.display_name}</strong></p><p>${user.email}</p>`;
            infoDiv.innerHTML += `<div class="track-info" id="track-info-${user.user_id}"><p><em>Loading current track...</em></p></div>`;

            userDiv.appendChild(img);
            userDiv.appendChild(infoDiv);
            document.getElementById("active-users").appendChild(userDiv);

            fetchTrackInfo(user.user_id);
        });

        // Remove user from the list
        socket.on("remove_user", (user) => {
            const userDiv = document.getElementById(`user-${user.user_id}`);
            if (userDiv) userDiv.remove();
        });

        // Function to fetch track info for a user
        function fetchTrackInfo(userId) {
            socket.emit('find_tracks', { user_id: userId });
        }

        // Update track information for a specific user
        socket.on("track_info", (data) => {
            const trackInfoDiv = document.getElementById(`track-info-${data.user_id}`);

            if (data.error) {
                trackInfoDiv.innerHTML = `<p>${data.error}</p>`;
            } else {
                trackInfoDiv.innerHTML = `
                    <p><strong>Currently Playing:</strong></p>
                    <p>${data.song_name} - ${data.artist_name}</p>
                    <img src="${data.album_image}" alt="${data.song_name}" width="100" height="100">
                `;
            }
        });
    </script>
</body>
</html>
